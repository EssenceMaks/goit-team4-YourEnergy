class c{constructor(){this.tasks=[],this.currentTaskId=null,this.modalEscapeListener=null,this.loadTheme(),this.loadTasks().then(()=>{this.init()})}async loadTasks(){try{const e=await(await fetch("https://script.google.com/macros/s/AKfycbwMbiYIzsnP07ciF6zVwV3jiajZT6_fNFBnYxN1vRJJbuQ2VVaS12a6RwYiRV3IxTjP/exec")).json();this.tasks=e.tasks||[],this.renderTasks()}catch(t){console.error("Error loading tasks:",t),this.tasks=[]}}async saveTasks(){try{return this.saveTimeout&&clearTimeout(this.saveTimeout),new Promise((t,e)=>{this.saveTimeout=setTimeout(async()=>{try{if(!(await fetch("https://script.google.com/macros/s/AKfycbwMbiYIzsnP07ciF6zVwV3jiajZT6_fNFBnYxN1vRJJbuQ2VVaS12a6RwYiRV3IxTjP/exec",{method:"POST",body:JSON.stringify({tasks:this.tasks})})).ok)throw new Error("Failed to save tasks");t()}catch(s){console.error("Error saving tasks:",s),e(s)}},300)})}catch(t){throw console.error("Error in saveTasks:",t),t}}init(){this.setupEventListeners(),this.renderTasks(),this.setupDragAndDrop()}setupEventListeners(){console.log("Setting up event listeners");const t=document.getElementById("addTaskBtn");console.log("Add button:",t),t.addEventListener("click",()=>{console.log("Add button clicked"),this.currentTaskId=null,this.showModal()}),document.querySelector(".close").addEventListener("click",()=>{this.hideModal()}),document.getElementById("taskForm").addEventListener("submit",s=>{s.preventDefault(),this.handleFormSubmit()}),document.getElementById("themeToggleBtn").addEventListener("click",()=>{this.toggleTheme()}),document.getElementById("taskNumber").addEventListener("input",s=>{this.handleTaskNumberInput(s.target.value)}),document.addEventListener("click",s=>{s.target.closest(".task-number-container")||(document.getElementById("taskNumberSuggestions").style.display="none")}),document.getElementById("addAssigneeBtn").addEventListener("click",()=>{this.addAssigneeField()}),document.getElementById("assigneesList").addEventListener("click",s=>{if(s.target.classList.contains("remove-assignee-btn")){const n=s.target.closest(".assignee-item");n&&document.querySelectorAll(".assignee-item").length>1&&n.remove()}}),document.getElementById("addSubtaskBtn").addEventListener("click",()=>{this.addSubtaskField()}),document.getElementById("subtasksList").addEventListener("click",s=>{s.target.classList.contains("remove-subtask-btn")&&s.target.closest(".subtask-item").remove()})}addAssigneeField(){document.getElementById("assigneesList").appendChild(this.createAssigneeItem("empty"))}addSubtaskField(t="",e=!1){const s=document.getElementById("subtasksList"),n=document.createElement("div");n.className="subtask-item",n.innerHTML=`
            <input type="checkbox" class="subtask-checkbox" ${e?"checked":""}>
            <input type="text" class="subtask-text" value="${t}" placeholder="Введите подзадачу">
            <button type="button" class="remove-subtask-btn">×</button>
        `,s.appendChild(n)}handleTaskNumberInput(t){const e=document.getElementById("taskNumberSuggestions"),s=document.getElementById("taskNumber");if(!t){s.classList.remove("exists","available"),e.style.display="none";return}const n=this.tasks.map(i=>i.taskNumber).filter(i=>i).sort((i,a)=>i-a),r=n.includes(t);if(s.classList.toggle("exists",r),s.classList.toggle("available",!r&&t.length>0),t.length>0){const i=n.filter(a=>a.toString().includes(t)).slice(0,5);i.length>0?(e.innerHTML=i.map(a=>`
                        <div class="suggestion-item" onclick="window.taskManager.selectTaskNumber('${a}')">
                            ${a}
                        </div>
                    `).join(""),e.style.display="block"):e.style.display="none"}else e.style.display="none"}selectTaskNumber(t){document.getElementById("taskNumber").value=t,document.getElementById("taskNumberSuggestions").style.display="none"}showModal(t=null){console.log("Opening modal for taskId:",t),console.log("All tasks:",this.tasks);const e=document.getElementById("taskModal"),s=document.getElementById("taskForm"),n=document.getElementById("assigneesList"),r=e.querySelector(".delete-task-btn");r.style.display=t?"block":"none",n.innerHTML="";const i=document.getElementById("subtasksList");if(i.innerHTML="",t){const a=this.tasks.find(o=>String(o.id)===String(t));if(console.log("Found task:",a),a){s.taskTitle.value=a.title||"",s.taskNumber.value=a.taskNumber||"",s.taskDescription.value=a.description||"",s.taskCategory.value=a.category||"Must_Have",s.taskPriority.value=a.priorityStatus||"normal",s.taskStatus.value=a.progressStatus||"who-take";const o=Array.isArray(a.assignees)?a.assignees:[a.assignee||"empty"];console.log("Processing assignees:",o),o.forEach(d=>{const l=this.createAssigneeItem(d);n.appendChild(l)}),a.subtasks&&Array.isArray(a.subtasks)&&(console.log("Processing subtasks:",a.subtasks),a.subtasks.forEach(d=>{typeof d=="string"?this.addSubtaskField(d,!1):typeof d=="object"&&this.addSubtaskField(d.text,d.completed)})),this.currentTaskId=t}else console.error("Task not found:",t)}else s.reset(),s.taskCategory.value="Must_Have",n.appendChild(this.createAssigneeItem("empty"));e.style.display="block",r.onclick=()=>this.showDeleteConfirmation(t),this.modalEscapeListener=a=>{a.key==="Escape"&&this.hideModal()},document.addEventListener("keydown",this.modalEscapeListener),e.addEventListener("click",a=>{a.target===e&&this.hideModal()})}showDeleteConfirmation(t){const e=document.getElementById("deleteConfirmModal");e.style.display="block";const s=()=>{this.deleteTask(t),e.style.display="none",this.hideModal(),a()},n=()=>{e.style.display="none",a()},r=o=>{o.target===e&&(e.style.display="none",a())},i=o=>{o.key==="Escape"&&(e.style.display="none",a())},a=()=>{document.getElementById("confirmDelete").removeEventListener("click",s),document.getElementById("cancelDelete").removeEventListener("click",n),e.removeEventListener("click",r),document.removeEventListener("keydown",i)};document.getElementById("confirmDelete").addEventListener("click",s),document.getElementById("cancelDelete").addEventListener("click",n),e.addEventListener("click",r),document.addEventListener("keydown",i)}hideModal(){const t=document.getElementById("taskModal");t.style.display="none",this.modalEscapeListener&&(document.removeEventListener("keydown",this.modalEscapeListener),this.modalEscapeListener=null)}handleFormSubmit(){const t=document.getElementById("taskForm"),e=Array.from(t.querySelectorAll(".subtask-item")).map(r=>({id:Date.now()+Math.random().toString(36).substr(2,9),text:r.querySelector(".subtask-text").value,completed:r.querySelector(".subtask-checkbox").checked})),s=Array.from(t.querySelectorAll(".taskAssignee")).map(r=>r.value).filter(r=>r);s.length===0&&s.push("empty");const n={title:t.taskTitle.value,taskNumber:t.taskNumber.value||null,description:t.taskDescription.value,category:t.taskCategory.value,priorityStatus:t.taskPriority.value,progressStatus:t.taskStatus.value,assignees:s,subtasks:e};if(n.taskNumber&&this.tasks.some(i=>i.taskNumber===n.taskNumber&&i.id!==this.currentTaskId)){alert("Задача с таким номером уже существует!");return}this.currentTaskId?this.updateTask(this.currentTaskId,n):this.addTask(n),this.hideModal(),this.renderTasks()}addTask(t){const e=()=>{const r=Date.now(),i=Math.floor(Math.random()*1e4);return`${r}-${i}`};let s;do s=e();while(this.tasks.some(r=>r.id===s));const n={id:s,taskNumber:t.taskNumber||null,title:t.title,description:t.description,category:t.category||"Must_Have",priorityStatus:t.priorityStatus,progressStatus:t.progressStatus,assignees:t.assignees,subtasks:t.subtasks||[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};this.tasks.push(n),this.saveTasks()}async updateTask(t,e){try{const s=this.tasks.findIndex(n=>String(n.id)===String(t));if(s!==-1){const n=this.tasks[s];this.tasks[s]={...n,title:e.title,taskNumber:e.taskNumber,description:e.description,category:e.category,priorityStatus:e.priorityStatus,progressStatus:e.progressStatus,assignees:e.assignees,subtasks:e.subtasks,updatedAt:new Date().toISOString()},await this.saveTasks(),this.renderTasks(),this.setupDragAndDrop(),console.log("Task updated successfully:",this.tasks[s])}else console.error("Task not found:",t)}catch(s){throw console.error("Error updating task:",s),s}}deleteTask(t){this.tasks=this.tasks.filter(e=>e.id!==t),this.saveTasks(),this.renderTasks()}renderTasks(){document.querySelectorAll(".drop-zone").forEach(s=>{s.innerHTML=""}),this.tasks.forEach(s=>{if(!s.assignees&&s.assignee&&(s.assignees=[s.assignee],delete s.assignee),s.assignees.some(r=>r!=="empty")){const r=this.createTaskElement(s),i=document.querySelector(`.drop-zone[data-priority="${s.priorityStatus}"][data-status="${s.progressStatus}"]`);i&&i.appendChild(r)}});const t=document.querySelector(".must-have-grid");if(t){t.innerHTML="";const s=this.tasks.filter(r=>r.category==="Must_Have"),n=this.groupTasksByAssignee(s,!0);this.renderGroupedTasks(n,t)}const e=document.querySelector(".upgrade-grid");if(e){e.innerHTML="";const s=this.tasks.filter(r=>r.category==="Upgrade"),n=this.groupTasksByAssignee(s,!0);this.renderGroupedTasks(n,e)}}createTaskElement(t){var r;const e=document.createElement("div");e.className="task-card",e.draggable=!0,e.dataset.taskId=t.id;const s=(t.assignees||[t.assignee||"empty"]).filter(i=>i!=="empty"),n=t.taskNumber?`№ ${t.taskNumber}`:"№ ***";if(e.innerHTML=`
            <div class="task-card-header">
                <div class="task-left">
                    <h4 class="task-title">${t.title}</h4>
                    <div class="task-number">${n}</div>
                    <p class="task-description">${t.description}</p>
                </div>
                <div class="task-right">
                    <div class="assignees-list">
                        ${s.map(i=>`
                            <div class="assignee-badge">${i}</div>
                        `).join("")}
                    </div>
                    <div class="task-status-badge">${t.progressStatus}</div>
                    <div class="category-badge" data-category="${t.category}">${t.category}</div>
                </div>
            </div>
        `,((r=t.subtasks)==null?void 0:r.length)>0){const i=t.subtasks.filter(o=>o.completed).length,a=t.subtasks.length;e.querySelector(".task-left").insertAdjacentHTML("beforeend",`
                <div class="subtasks-progress">
                    ${i}/${a}
                </div>
            `)}return e.addEventListener("click",()=>this.showModal(t.id)),e}setupDragAndDrop(){console.log("Setting up drag and drop"),document.removeEventListener("dragstart",this.handleDragStart),document.removeEventListener("dragend",this.handleDragEnd),this.handleDragStart=e=>{e.target.classList.contains("task-card")&&(e.target.classList.add("dragging"),e.dataTransfer.setData("text/plain",e.target.dataset.taskId))},this.handleDragEnd=e=>{e.target.classList.contains("task-card")&&e.target.classList.remove("dragging")},document.addEventListener("dragstart",this.handleDragStart),document.addEventListener("dragend",this.handleDragEnd),document.querySelectorAll(".drop-zone").forEach(e=>{e.removeEventListener("dragover",this.handleDragOver),e.removeEventListener("dragleave",this.handleDragLeave),e.removeEventListener("drop",this.handleDrop),this.handleDragOver=s=>{s.preventDefault(),e.classList.add("dragover")},this.handleDragLeave=()=>{e.classList.remove("dragover")},this.handleDrop=async s=>{s.preventDefault(),e.classList.remove("dragover");const n=s.dataTransfer.getData("text/plain"),r=this.tasks.find(i=>String(i.id)===String(n));if(r){const i=document.querySelector(`[data-task-id="${n}"]`);i&&e.appendChild(i),r.priorityStatus=e.dataset.priority,r.progressStatus=e.dataset.status,r.updatedAt=new Date().toISOString(),this.saveTasks().catch(a=>{console.error("Error saving task:",a),this.renderTasks()})}},e.addEventListener("dragover",this.handleDragOver),e.addEventListener("dragleave",this.handleDragLeave),e.addEventListener("drop",this.handleDrop)})}loadTheme(){const t=localStorage.getItem("theme")||"dark";document.documentElement.setAttribute("data-theme",t)}toggleTheme(){const e=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e)}groupTasksByAssignee(t,e=!1){const s={};return t.forEach(n=>{(n.assignees||[n.assignee||"empty"]).forEach(i=>{(i!=="empty"||e)&&(s[i]||(s[i]=[]),s[i].includes(n)||s[i].push(n))})}),s}renderGroupedTasks(t,e){Object.entries(t).forEach(([s,n])=>{const r=document.createElement("div");r.className="task-assignee",r.innerHTML=`
                <div class="assignee-name ${s==="empty"?"empty-assignee":""}">
                    ${s}
                </div>
                ${n.map(a=>`
                    <div class="task-status" data-task-id="${a.id}">${a.progressStatus}</div>
                `).join("")}
            `,r.addEventListener("click",a=>{const o=a.target.dataset.taskId;o&&this.showModal(o)}),e.appendChild(r);const i=document.createElement("div");i.className="task-content",i.innerHTML=n.map(a=>`
                <div class="task-item" data-task-id="${a.id}">
                    <h4>${a.title}</h4>
                    <div class="task-assignees">
                        ${(a.assignees||[a.assignee||"empty"]).map(o=>`
                            <span class="assignee-badge">${o}</span>
                        `).join("")}
                    </div>
                    <p>${a.description}</p>
                </div>
            `).join(""),i.addEventListener("click",a=>{const o=a.target.closest(".task-item");if(o){const d=o.dataset.taskId;this.showModal(d)}}),e.appendChild(i)})}createAssigneeSelect(){return`
            <select class="taskAssignee" required>
                <option value="empty">Empty</option>
                <option value="Andrii Sushylnikov">Andrii Sushylnikov</option>
                <option value="Daria Honcharuk">Daria Honcharuk</option>
                <option value="Dmytro Mayevsky">Dmytro Mayevsky</option>
                <option value="Maks Ki">Maks Ki</option>
                <option value="Mariia Sv.">Mariia Sv.</option>
                <option value="Roman Turas">Roman Turas</option>
                <option value="Viktoriia Didenko">Viktoriia Didenko</option>
                <option value="Hryhorii Chernysh">Hryhorii Chernysh (Mentor)</option>
                <option value="Daria">Daria (client manager)</option>
                <option value="Lesya Katanova">Lesya Katanova</option>
                <option value="Olena Deineha">Olena Deineha</option>
            </select>
        `}createAssigneeItem(t="empty"){const e=document.createElement("div");return e.className="assignee-item",e.innerHTML=`
            ${this.createAssigneeSelect()}
            <button type="button" class="remove-assignee-btn">×</button>
        `,e.querySelector("select").value=t,e}}document.addEventListener("DOMContentLoaded",()=>{window.taskManager=new c});
//# sourceMappingURL=task-manager-DOtOvWIw.js.map
